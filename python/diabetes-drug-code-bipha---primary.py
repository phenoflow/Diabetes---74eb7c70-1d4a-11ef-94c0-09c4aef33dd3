# Ellie Paige, Jessica Barret, David Stevens, Ruth H Keogh, Michael J Sweeting, Irwin Nazareth, Irene Peterson, Angela M Wood, 2024.

import sys, csv, re

codes = [{"code":"94298998","system":"readv2"},{"code":"91294998","system":"readv2"},{"code":"86278998","system":"readv2"},{"code":"94328998","system":"readv2"},{"code":"86300998","system":"readv2"},{"code":"86259998","system":"readv2"},{"code":"90697998","system":"readv2"},{"code":"86288998","system":"readv2"},{"code":"91292997","system":"readv2"},{"code":"92906998","system":"readv2"},{"code":"86248998","system":"readv2"},{"code":"91292998","system":"readv2"},{"code":"86298998","system":"readv2"},{"code":"86029998","system":"readv2"},{"code":"90684997","system":"readv2"},{"code":"96062998","system":"readv2"},{"code":"86250998","system":"readv2"},{"code":"94319998","system":"readv2"},{"code":"91294997","system":"readv2"},{"code":"90682998","system":"readv2"},{"code":"86295998","system":"readv2"},{"code":"86304998","system":"readv2"},{"code":"91275997","system":"readv2"},{"code":"91293997","system":"readv2"},{"code":"86306998","system":"readv2"},{"code":"90684998","system":"readv2"},{"code":"86260998","system":"readv2"},{"code":"91275996","system":"readv2"},{"code":"91701998","system":"readv2"},{"code":"91290998","system":"readv2"},{"code":"81790998","system":"readv2"},{"code":"97051998","system":"readv2"},{"code":"99196998","system":"readv2"},{"code":"91273997","system":"readv2"},{"code":"86284998","system":"readv2"},{"code":"89990998","system":"readv2"},{"code":"87967998","system":"readv2"},{"code":"90169998","system":"readv2"},{"code":"90682997","system":"readv2"},{"code":"81687998","system":"readv2"},{"code":"94436998","system":"readv2"},{"code":"86249998","system":"readv2"},{"code":"86186998","system":"readv2"},{"code":"92908998","system":"readv2"},{"code":"92909998","system":"readv2"},{"code":"98225998","system":"readv2"},{"code":"86078998","system":"readv2"},{"code":"90683998","system":"readv2"},{"code":"86279998","system":"readv2"},{"code":"97052996","system":"readv2"},{"code":"86188998","system":"readv2"},{"code":"86301998","system":"readv2"},{"code":"83404998","system":"readv2"},{"code":"91292996","system":"readv2"},{"code":"90684996","system":"readv2"},{"code":"86294998","system":"readv2"},{"code":"89990997","system":"readv2"},{"code":"87411979","system":"readv2"},{"code":"92376997","system":"readv2"},{"code":"94413998","system":"readv2"},{"code":"99415998","system":"readv2"},{"code":"86287998","system":"readv2"},{"code":"90697997","system":"readv2"},{"code":"92376996","system":"readv2"},{"code":"91290997","system":"readv2"},{"code":"81963998","system":"readv2"},{"code":"98895998","system":"readv2"},{"code":"90697996","system":"readv2"},{"code":"91275998","system":"readv2"},{"code":"87365979","system":"readv2"},{"code":"91291998","system":"readv2"},{"code":"89888998","system":"readv2"},{"code":"91273998","system":"readv2"},{"code":"88978998","system":"readv2"},{"code":"86169998","system":"readv2"},{"code":"94337998","system":"readv2"},{"code":"86247998","system":"readv2"},{"code":"86261998","system":"readv2"},{"code":"86262998","system":"readv2"},{"code":"86189998","system":"readv2"},{"code":"86282998","system":"readv2"},{"code":"97052997","system":"readv2"},{"code":"89555998","system":"readv2"},{"code":"86283998","system":"readv2"},{"code":"97052998","system":"readv2"},{"code":"82457998","system":"readv2"},{"code":"86187998","system":"readv2"},{"code":"86280998","system":"readv2"},{"code":"90683997","system":"readv2"},{"code":"91289998","system":"readv2"},{"code":"86286998","system":"readv2"},{"code":"86077998","system":"readv2"},{"code":"82458998","system":"readv2"},{"code":"98226998","system":"readv2"},{"code":"86308998","system":"readv2"},{"code":"87373979","system":"readv2"},{"code":"91290996","system":"readv2"},{"code":"96053997","system":"readv2"},{"code":"86303998","system":"readv2"},{"code":"86305998","system":"readv2"},{"code":"97051997","system":"readv2"},{"code":"91700998","system":"readv2"},{"code":"92932998","system":"readv2"},{"code":"87416979","system":"readv2"},{"code":"91291997","system":"readv2"},{"code":"91293998","system":"readv2"},{"code":"86310998","system":"readv2"},{"code":"92323998","system":"readv2"},{"code":"92907998","system":"readv2"},{"code":"86281998","system":"readv2"},{"code":"86309998","system":"readv2"},{"code":"89554998","system":"readv2"},{"code":"86291998","system":"readv2"},{"code":"86028998","system":"readv2"},{"code":"86311998","system":"readv2"},{"code":"83405998","system":"readv2"}];
REQUIRED_CODES = 1;
with open(sys.argv[1], 'r') as file_in, open('diabetes-potential-cases.csv', 'w', newline='') as file_out:
    csv_reader = csv.DictReader(file_in)
    csv_writer = csv.DictWriter(file_out, csv_reader.fieldnames + ["diabetes-drug-code-bipha---primary-identified"])
    csv_writer.writeheader();
    codes_identified = 0;
    for row in csv_reader:
        newRow = row.copy();
        for cell in row:
            # Iterate cell lists (e.g. codes)
            for item in re.findall(r'\(([^,]*)\,', row[cell]):
                if(item in list(map(lambda code: code['code'], codes))): codes_identified+=1;
                if(codes_identified>=REQUIRED_CODES):
                    newRow["diabetes-drug-code-bipha---primary-identified"] = "CASE";
                    break;
            if(codes_identified>=REQUIRED_CODES): break;
        if(codes_identified<REQUIRED_CODES):
            newRow["diabetes-drug-code-bipha---primary-identified"] = "UNK";
        codes_identified=0;
        csv_writer.writerow(newRow)
